<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: html(title=${analisisSer.getTituloLocalizado(analisis)}, content=~{::content})}">
<head>
  <meta charset="UTF-8">
  <title>Título del Análisis Filosófico</title>
</head>
<body>
<div th:fragment="content">
  <!-- Alertas y mensajes -->
  <div th:if="${param.comentarioEnviado}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> <span th:text="#{comentarios.enviado.pendiente}">Tu comentario ha sido enviado y está pendiente de aprobación.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div th:if="${param.estadoActualizado}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> <span th:text="#{comentarios.estado.actualizado}">El estado del comentario ha sido actualizado correctamente.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Detalles del análisis -->
  <div class="row mb-4">
    <div class="col-md-8">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a th:href="@{/}" th:text="#{nav.home}">Inicio</a></li>
          <li class="breadcrumb-item">
            <a th:href="@{'/series/' + ${analisis.episodio.serie.id}}"
               th:text="${serieSer.getTituloLocalizado(analisis.episodio.serie)}">Serie</a>
          </li>
          <li class="breadcrumb-item">
            <a th:href="@{'/episodios/' + ${analisis.episodio.id}}"
               th:text="${'T' + analisis.episodio.numeroTemporada + 'E' + analisis.episodio.numeroEpisodio + ' - ' + episodioSer.getTituloLocalizado(analisis.episodio)}">Episodio</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page" th:text="${analisisSer.getTituloLocalizado(analisis)}">Análisis</li>
        </ol>
      </nav>
      <h1 class="display-4 mb-3" th:text="${analisisSer.getTituloLocalizado(analisis)}">Título del Análisis</h1>
      <div class="d-flex align-items-center mb-4">
        <div class="me-3">
          <span class="text-muted" th:text="#{analisis.autor}">Por</span>
          <span class="fw-bold" th:text="${analisis.filosofo.nombre}">AutorFilosofo</span>
        </div>
        <div class="me-3">
          <i class="bi bi-calendar-event text-muted"></i>
          <span class="text-muted" th:text="${#temporals.format(analisis.fechaPublicacion, 'dd/MM/yyyy')}">01/01/2023</span>
        </div>
        <div>
          <i class="bi bi-tags text-muted"></i>
          <span class="badge bg-primary me-1" th:text="${analisis.categoria.nombreEs}">Categoría</span>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-md-end">
      <a th:href="@{'/episodios/' + ${analisis.episodio.id}}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> <span th:text="#{analisis.volver.episodio}">Volver al Episodio</span>
      </a>
    </div>
  </div>

  <!-- Contenido del análisis según el idioma actual del sistema -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="analisis-contenido"
               th:utext="${#locale.language == 'es' ? analisis.contenidoEs :
                          #locale.language == 'en' ? analisis.contenidoEn :
                          #locale.language == 'de' ? analisis.contenidoDe :
                          analisis.contenidoEs}">
            Contenido del análisis...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de comentarios -->
  <div class="row mb-5">
    <div class="col-12">
      <h3 class="mb-4" th:text="#{comentarios.titulo}">Comentarios</h3>

      <!-- Panel de moderación (solo visible para MOD y ADMIN) -->
      <div sec:authorize="hasAnyRole('MOD', 'ADMIN')" class="card border-primary mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-shield-check me-2"></i> <span th:text="#{comentarios.moderacion}">Panel de Moderación</span>
          </h5>
        </div>
        <div class="card-body">
          <div th:if="${comentariosModeracion == null || #lists.isEmpty(comentariosModeracion)}" class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i> <span th:text="#{comentarios.moderacion.vacio}">No hay comentarios pendientes de moderación.</span>
          </div>

          <div th:if="${comentariosModeracion != null && !#lists.isEmpty(comentariosModeracion)}" class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
              <tr>
                <th th:text="#{comentarios.usuario}">Usuario</th>
                <th th:text="#{comentarios.fecha}">Fecha</th>
                <th th:text="#{comentarios.contenido}">Contenido</th>
                <th th:text="#{comentarios.acciones}">Acciones</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="comentario : ${comentariosModeracion}">
                <td th:text="${comentario.usuario.username}">Usuario</td>
                <td th:text="${#temporals.format(comentario.fechaCreacion, 'dd/MM/yyyy HH:mm')}">01/01/2023 12:00</td>
                <td th:text="${comentario.contenido}">Contenido del comentario...</td>
                <td>
                  <div class="btn-group">
                    <form th:action="@{'/analisis/' + ${analisis.id} + '/comentarios/' + ${comentario.id} + '/estado'}" method="post" class="me-1">
                      <input type="hidden" name="nuevoEstado" value="APROBADO">
                      <button type="submit" class="btn btn-sm btn-success" title="Aprobar">
                        <i class="bi bi-check-lg"></i> <span th:text="#{comentarios.aprobar}">Aprobar</span>
                      </button>
                    </form>
                    <form th:action="@{'/analisis/' + ${analisis.id} + '/comentarios/' + ${comentario.id} + '/estado'}" method="post">
                      <input type="hidden" name="nuevoEstado" value="RECHAZADO">
                      <button type="submit" class="btn btn-sm btn-danger" title="Rechazar">
                        <i class="bi bi-x-lg"></i> <span th:text="#{comentarios.rechazar}">Rechazar</span>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tus comentarios pendientes (visible solo para el usuario logeado) -->
      <div sec:authorize="isAuthenticated()" th:if="${comentariosPendientes != null && !#lists.isEmpty(comentariosPendientes)}" class="alert alert-warning mb-4">
        <h5 class="alert-heading">
          <i class="bi bi-clock-history me-2"></i> <span th:text="#{comentarios.tus.pendientes}">Tus comentarios pendientes</span>
        </h5>
        <p th:text="#{comentarios.pendientes.nota}">Tienes los siguientes comentarios pendientes de aprobación por los moderadores:</p>
        <div class="list-group mt-3">
          <div th:each="comentario : ${comentariosPendientes}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1" th:text="${#temporals.format(comentario.fechaCreacion, 'dd/MM/yyyy HH:mm')}">01/01/2023 12:00</h6>
              <span class="badge bg-warning text-dark" th:text="#{comentarios.estado.pendiente}">Pendiente</span>
            </div>
            <p class="mb-1" th:text="${comentario.contenido}">Contenido del comentario...</p>
          </div>
        </div>
      </div>

      <!-- Tus comentarios rechazados (visible solo para el usuario logeado) -->
      <div sec:authorize="isAuthenticated()" th:if="${comentariosRechazados != null && !#lists.isEmpty(comentariosRechazados)}" class="alert alert-danger mb-4">
        <h5 class="alert-heading">
          <i class="bi bi-x-circle me-2"></i> <span th:text="#{comentarios.tus.rechazados}">Tus comentarios rechazados</span>
        </h5>
        <p th:text="#{comentarios.rechazados.nota}">Los siguientes comentarios han sido rechazados por los moderadores:</p>
        <div class="list-group mt-3">
          <div th:each="comentario : ${comentariosRechazados}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1" th:text="${#temporals.format(comentario.fechaCreacion, 'dd/MM/yyyy HH:mm')}">01/01/2023 12:00</h6>
              <span class="badge bg-danger" th:text="#{comentarios.estado.rechazado}">Rechazado</span>
            </div>
            <p class="mb-1" th:text="${comentario.contenido}">Contenido del comentario...</p>
          </div>
        </div>
      </div>

      <!-- Lista de comentarios aprobados -->
      <div th:if="${#lists.isEmpty(comentarios)}" class="alert alert-info">
        <p th:text="#{comentarios.vacio}">No hay comentarios aprobados para este análisis. ¡Sé el primero en comentar!</p>
      </div>

      <div class="comentarios-lista mb-4">
        <div th:each="comentario : ${comentarios}" class="card mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
              <strong th:text="${comentario.usuario.username}">Usuario</strong>
              <span class="text-muted ms-2" th:text="${#temporals.format(comentario.fechaCreacion, 'dd/MM/yyyy HH:mm')}">01/01/2023 12:00</span>
            </div>
          </div>
          <div class="card-body">
            <p class="card-text" th:text="${comentario.contenido}">Contenido del comentario...</p>
          </div>
        </div>
      </div>

      <!-- Formulario para añadir comentario (solo para usuarios autenticados) -->
      <div sec:authorize="isAuthenticated()" class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0" th:text="#{comentarios.agregar}">Agregar comentario</h5>
        </div>
        <div class="card-body">
          <form th:action="@{'/analisis/' + ${analisis.id} + '/comentar'}" th:object="${nuevoComentario}" method="post">
            <div class="mb-3">
              <label for="contenido" class="form-label" th:text="#{comentarios.contenido}">Tu comentario</label>
              <textarea th:field="*{contenido}" class="form-control" id="contenido" rows="3" required></textarea>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i> <span th:text="#{comentarios.nota}">Tu comentario será revisado por un moderador antes de ser publicado.</span>
              </div>
            </div>
            <button type="submit" class="btn btn-primary" th:text="#{comentarios.enviar}">Enviar comentario</button>
          </form>
        </div>
      </div>

      <!-- Mensaje para usuarios no autenticados -->
      <div sec:authorize="!isAuthenticated()" class="alert alert-secondary">
        <p th:text="#{comentarios.login}">Debes iniciar sesión para poder comentar.</p>
        <a th:href="@{/login}" class="btn btn-primary" th:text="#{nav.login}">Iniciar sesión</a>
        <span class="mx-2" th:text="#{o}">o</span>
        <a th:href="@{/registro}" class="btn btn-outline-primary" th:text="#{nav.registro}">Registrarse</a>
      </div>
    </div>
  </div>
</div>
</body>
</html>